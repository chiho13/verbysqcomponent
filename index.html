<!DOCTYPE html>
<html>
  <head>
    <script src="https://unpkg.com/react@17.0.2/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17.0.2/umd/react-dom.development.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.26.0/babel.min.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>

    <style>
      .dropdown {
        position: relative;
        margin-bottom: 20px;
      }
      /* Dropdown Button */
      .dropdown-menu {
        position: absolute;
        z-index: 1;
        display: none;
        background-color: lightgray;
      }
      /* Show the dropdown menu (use JS to add this class to the .dropdown-content container when the user clicks on the dropdown button) */
      .show {
        display: block;
      }

      .play-icon,
      .stop-icon {
        cursor: pointer;
      }

      .play-icon:hover path,
      .stop-icon:hover path {
        stroke: #f07d3b;
        transition: stroke 0.3s ease;
      }

      .play-icon path,
      .stop-icon path {
        pointer-events: none;
      }

      .voiceItemContainer {
        padding-left: 10px;
      }
      .voiceItemContainer:hover {
        background-color: #eeeeee;
        transition: all 0.3s ease;
      }
    </style>
  </head>
  <body>
    <div id="app"></div>
    <script type="text/babel">
      function App() {
        const [selectedItemText, setSelectedItemText] =
          React.useState("Choose a voice");
        const [selectedVoiceId, setSelectedVoiceId] = React.useState("");

        const [sampleSrc, setSampleSrc] = React.useState("");

        const [sampleAudioElement, setSampleAudioElement] =
          React.useState(null);

        const [voices, setVoices] = React.useState([]);

        const voicesDropdownRef = React.useRef(null);

        const sampleAudioRef = React.useRef(null);

        function handleVoicesDropdownClick(event) {
          event.preventDefault();
          event.stopPropagation();
          voicesDropdownRef.current.classList.toggle("show");
        }

        const dropdownMenu = document.getElementById("menuItems");

        function handleVoiceSelection(voice, name) {
          setSelectedVoiceId(voice);
          setSelectedItemText(name);
          voicesDropdownRef.current.classList.remove("show");
        }

        const [playingStates, setPlayingStates] = React.useState(
          new Array(voices.length).fill(false)
        );

        function playAudio(index) {
          if (sampleAudioElement) {
            sampleAudioElement.pause();
          }
          const newAudioElement = new Audio(voices[index].preview_url);
          newAudioElement.play();
          setSampleAudioElement(newAudioElement);
          //   setIsPlaying(true);
          setPlayingStates((prevStates) => {
            const newStates = [...prevStates];
            newStates[index] = true;
            return newStates;
          });

          newAudioElement.addEventListener("ended", () => {
            setPlayingStates((prevStates) => {
              const newStates = [...prevStates];
              newStates[index] = false;
              return newStates;
            });
          });
        }

        function stopAudio(index) {
          if (sampleAudioElement) {
            sampleAudioElement.currentTime = 0;
            sampleAudioElement.pause();
          }
          setPlayingStates((prevStates) => {
            const newStates = [...prevStates];
            newStates[index] = false;
            return newStates;
          });
        }

        function SampleAudioVoice({
          previewUrl,
          setAudioElement,
          isPlaying,
          playAudio,
          stopAudio,
        }) {
          return (
            <div>
              {isPlaying ? (
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke-width="1.5"
                  stroke="currentColor"
                  class="stop-icon w-10 h-10 mr-2"
                  onClick={stopAudio}
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                  />
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M9 9.563C9 9.252 9.252 9 9.563 9h4.874c.311 0 .563.252.563.563v4.874c0 .311-.252.563-.563.563H9.564A.562.562 0 019 14.437V9.564z"
                  />
                </svg>
              ) : (
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke-width="1.5"
                  stroke="currentColor"
                  class="play-icon w-10 h-10 mr-2"
                  data-preview-url="${voice.preview_url}"
                  onClick={playAudio}
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                  />
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M15.91 11.672a.375.375 0 010 .656l-5.603 3.113a.375.375 0 01-.557-.328V8.887c0-.286.307-.466.557-.327l5.603 3.112z"
                  />
                </svg>
              )}
            </div>
          );
        }

        React.useEffect(() => {
          fetch("http://localhost:3000/voices")
            .then((response) => response.json())
            .then((data) => {
              setVoices(data.voices);
              console.log(data.voices);
            })
            .catch((error) => console.error(error));
        }, []);

        React.useEffect(() => {
          const handleClickOutsideDropdown = (event) => {
            if (
              voicesDropdownRef.current &&
              !voicesDropdownRef.current.contains(event.target) &&
              event.target.tagName !== "svg"
            ) {
              voicesDropdownRef.current.classList.remove("show");
            }
          };

          document.addEventListener("click", handleClickOutsideDropdown);

          return () => {
            document.removeEventListener("click", handleClickOutsideDropdown);
          };
        }, [voicesDropdownRef]);

        const MemoizedSampleAudioVoice = React.memo(SampleAudioVoice);

        return (
          <div className="container p-4">
            <div className="dropdown">
              <div>
                <button
                  className="dropdown-toggle inline-flex justify-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 focus:ring-offset-gray-100"
                  aria-expanded="true"
                  aria-haspopup="true"
                  id="voices-dropdown"
                  onClick={handleVoicesDropdownClick}
                >
                  <span> {selectedItemText}</span>
                  <svg
                    class="-mr-1 ml-2 h-5 w-5"
                    viewBox="0 0 20 20"
                    fill="currentColor"
                    aria-hidden="true"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z"
                      clip-rule="evenodd"
                    />
                  </svg>
                </button>
              </div>

              <div
                id="menuItems"
                className="dropdown-menu absolute left-0 z-10 mt-2 w-56 origin-top-right rounded-md bg-white shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none"
                role="menu"
                aria-orientation="vertical"
                aria-labelledby="voices-dropdown"
                tabIndex="-1"
                ref={voicesDropdownRef}
              >
                {voices.map((voice, index) => (
                  <div class="flex py-2 voiceItemContainer">
                    <MemoizedSampleAudioVoice
                      key={index}
                      previewUrl={voice.preview_url}
                      setAudioElement={setSampleAudioElement}
                      isPlaying={playingStates[index]}
                      playAudio={() => playAudio(index)}
                      stopAudio={() => stopAudio(index)}
                    />
                    <a
                      href="#"
                      className="flex items-center text-gray-700 block px-2 py-2 text-sm w-full"
                      role="menuitem"
                      tabIndex="-1"
                      id="single-menu-item"
                      onClick={(e) =>
                        handleVoiceSelection(voice.voice_id, voice.name)
                      }
                    >
                      <span className="voiceNameItem">{voice.name}</span>
                    </a>
                  </div>
                ))}
              </div>
            </div>

            <audio
              id="sample-audio"
              ref={sampleAudioRef}
              class="block mb-4"
              src={sampleSrc}
              style={{ display: "none" }}
            ></audio>
          </div>
        );
      }

      ReactDOM.render(<App />, document.getElementById("app"));
    </script>
  </body>
</html>
